<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è´¢åŠ¡çœ‹æ¿ Pro+</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #f8fafc; --card-bg: rgba(255, 255, 255, 0.9); --text: #1e293b; --primary: #6366f1;
            --border: rgba(0,0,0,0.05);
        }
        @media (prefers-color-scheme: dark) {
            :root { --bg: #0f172a; --card-bg: rgba(30, 41, 59, 0.8); --text: #f8fafc; --border: rgba(255,255,255,0.1); }
        }

        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; transition: 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* PC ç«¯å¼ºåˆ¶ 2 åˆ—å¸ƒå±€ï¼Œé¿å…ç©ºæ—· */
        .main-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        /* æ‰‹æœºç«¯åˆ‡å›å•åˆ— */
        @media (max-width: 850px) {
            .main-grid { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        .full-width { grid-column: 1 / -1; } /* å¹´åº¦å¤§ç›˜ç‚¹æ¨ªè·¨æ•´è¡Œ */

        .stat-group { display: flex; gap: 15px; margin-bottom: 24px; }
        .stat-item { flex: 1; padding: 15px; border-radius: 15px; background: rgba(99, 102, 241, 0.1); }
        .stat-label { font-size: 12px; opacity: 0.7; }
        .stat-val { font-size: 20px; font-weight: bold; margin-top: 5px; }

        .chart-container { height: 280px; position: relative; }
        
        /* åˆ†ç±»ä¸‹é’»åˆ—è¡¨æ ·å¼ */
        #detail-section { margin-top: 24px; display: none; }
        .detail-item { 
            display: flex; justify-content: space-between; padding: 12px; 
            border-bottom: 1px solid var(--border); font-size: 14px;
        }
        .detail-item:last-child { border: none; }

        h2 { font-size: 1.25rem; margin-top: 0; display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div class="header" style="margin-bottom: 30px;">
            <h1>è´¢åŠ¡å¤§ç›˜ç‚¹ ğŸš€</h1>
            <div class="stat-group">
                <div class="stat-item">
                    <div class="stat-label">æ€»æ”¯å‡º (CNY)</div>
                    <div id="total-exp" class="stat-val" style="color:#ef4444">Â¥0.00</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ€»æ”¶å…¥ (CNY)</div>
                    <div id="total-inc" class="stat-val" style="color:#10b981">Â¥0.00</div>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="card full-width">
                <h2>ğŸ“… å¹´åº¦æ”¶æ”¯è¶‹åŠ¿</h2>
                <div class="chart-container" style="height: 350px;">
                    <canvas id="annualChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ• æ”¯å‡ºæ„æˆ (ç‚¹å‡»æ‰‡åŒºæŸ¥çœ‹æ˜ç»†)</h2>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ“ˆ æœ€è¿‘ 30 å¤©æ”¯å‡ºæ›²çº¿</h2>
                <div class="chart-container">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>

            <div class="card full-width" id="detail-section">
                <h2 id="detail-title">ğŸ“‚ åˆ†ç±»æ˜ç»†</h2>
                <div id="detail-list"></div>
            </div>
        </div>
    </div>

    <script>
        const WORKER_BASE = "https://ä½ çš„worker.workers.dev"; // æ›¿æ¢åœ°å€
        const userId = new URLSearchParams(window.location.search).get('user_id');

        async function fetchData(category = null) {
            const url = category 
                ? `${WORKER_BASE}/api/data?user_id=${userId}&category=${encodeURIComponent(category)}`
                : `${WORKER_BASE}/api/data?user_id=${userId}`;
            const res = await fetch(url);
            return await res.json();
        }

        async function renderDetail(category) {
            const section = document.getElementById('detail-section');
            const list = document.getElementById('detail-list');
            document.getElementById('detail-title').innerText = `ğŸ“‚ ${category} - æœ€è¿‘æ˜ç»†`;
            
            section.style.display = 'block';
            list.innerHTML = 'åŠ è½½ä¸­...';
            
            const data = await fetchData(category);
            list.innerHTML = data.map(item => `
                <div class="detail-item">
                    <span>${item.date} | ${item.description}</span>
                    <b style="color:${item.type==='income'?'#10b981':'#ef4444'}">
                        ${item.type==='income'?'+':'-'}${item.amount_original} ${item.currency_original}
                    </b>
                </div>
            `).join('');
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°æ˜ç»†åŒº
            section.scrollIntoView({ behavior: 'smooth' });
        }

        async function init() {
            if (!userId) return alert("è¯·ä»æœºå™¨äººè¿›å…¥");
            const data = await fetchData();

            // æ›´æ–°æ€»é¢
            document.getElementById('total-exp').innerText = `Â¥${(data.totals.find(t=>t.type==='expense')?.total || 0).toFixed(2)}`;
            document.getElementById('total-inc').innerText = `Â¥${(data.totals.find(t=>t.type==='income')?.total || 0).toFixed(2)}`;

            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const themeColor = isDark ? '#94a3b8' : '#64748b';

            // 1. å¹´åº¦æ”¶æ”¯å›¾ (åŒæŸ±çŠ¶å›¾)
            new Chart(document.getElementById('annualChart'), {
                type: 'bar',
                data: {
                    labels: data.annual.map(i => `${i.month}æœˆ`),
                    datasets: [
                        { label: 'æ”¯å‡º', data: data.annual.map(i => i.exp), backgroundColor: '#6366f1' },
                        { label: 'æ”¶å…¥', data: data.annual.map(i => i.inc), backgroundColor: '#10b981' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: 'rgba(0,0,0,0.05)' } } } }
            });

            // 2. é¥¼å›¾ (ç‚¹å‡»äº‹ä»¶)
            const pieCtx = document.getElementById('pieChart');
            new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: data.pie.map(i => i.category),
                    datasets: [{ data: data.pie.map(i => i.value), backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6'] }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const category = data.pie[index].category;
                            renderDetail(category);
                        }
                    },
                    plugins: { legend: { position: 'right' } }
                }
            });

            // 3. è¶‹åŠ¿å›¾
            new Chart(document.getElementById('lineChart'), {
                type: 'line',
                data: {
                    labels: data.line.map(i => i.date.slice(5)),
                    datasets: [{ data: data.line.map(i => i.value), borderColor: '#6366f1', tension: 0.4, fill: true, backgroundColor: 'rgba(99, 102, 241, 0.1)' }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        init();
    </script>
</body>
</html>
