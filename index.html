<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI è´¢åŠ¡çœ‹æ¿ Pro+</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- 1. ç³»ç»Ÿè‡ªé€‚åº”ä¸»é¢˜å˜é‡ --- */
        :root {
            --bg: #f1f5f9;
            --card-bg: rgba(255, 255, 255, 0.8);
            --card-border: rgba(255, 255, 255, 0.5);
            --text-main: #1e293b;
            --text-sub: #64748b;
            --primary: #6366f1;
            --success: #10b981;
            --danger: #ef4444;
            --grid-line: rgba(0, 0, 0, 0.05);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f172a;
                --card-bg: rgba(30, 41, 59, 0.7);
                --card-border: rgba(255, 255, 255, 0.08);
                --text-main: #f8fafc;
                --text-sub: #94a3b8;
                --grid-line: rgba(255, 255, 255, 0.05);
            }
        }

        /* --- 2. åŸºç¡€å¸ƒå±€ --- */
        * { box-sizing: border-box; transition: all 0.3s ease; }
        body {
            font-family: -apple-system, "SF Pro Display", "PingFang SC", sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0; padding: 20px; min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }

        /* --- 3. é¢„ç®—é¢„è­¦ç»„ä»¶ --- */
        .budget-card {
            margin-bottom: 24px; padding: 24px; border-radius: 24px;
            background: var(--card-bg); backdrop-filter: blur(15px);
            border: 1px solid var(--card-border);
        }
        .progress-container { height: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; overflow: hidden; margin: 12px 0; }
        @media (prefers-color-scheme: dark) { .progress-container { background: rgba(255,255,255,0.1); } }
        .progress-bar { height: 100%; width: 0; transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        .over-budget-text { color: var(--danger); font-weight: 800; animation: shake 0.5s ease-in-out infinite alternate; display: inline-block; }
        @keyframes shake { from { transform: translateX(0); } to { transform: translateX(5px); } }

        /* --- 4. å“åº”å¼æ …æ ¼ç³»ç»Ÿ --- */
        .main-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* ç”µè„‘ç«¯é»˜è®¤ä¸¤åˆ— */
            gap: 24px;
        }

        .full-width { grid-column: 1 / -1; } /* å¹´åº¦å›¾è¡¨æ¨ªè·¨å…¨å± */

        @media (max-width: 850px) {
            .main-grid { grid-template-columns: 1fr; } /* æ‰‹æœºç«¯åˆ‡å›å•åˆ— */
        }

        /* --- 5. å¡ç‰‡æ ·å¼ --- */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
        }
        .card h3 { font-size: 16px; margin: 0 0 20px; display: flex; align-items: center; }
        .card h3::before { content: ""; width: 4px; height: 16px; background: var(--primary); margin-right: 10px; border-radius: 2px; }

        .chart-box { position: relative; width: 100%; height: 300px; }
        .stat-val { font-size: 28px; font-weight: 800; margin-bottom: 4px; }

        /* --- 6. ä¸‹é’»æ˜ç»†åˆ—è¡¨ --- */
        #detail-section { margin-top: 24px; display: none; }
        .detail-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; border-bottom: 1px solid var(--grid-line);
        }
        .detail-row:last-child { border: none; }
        .detail-info { display: flex; flex-direction: column; }
        .detail-date { font-size: 12px; color: var(--text-sub); }
        .detail-amt { font-weight: 700; font-family: "SF Mono", monospace; }

        /* åŠ è½½çŠ¶æ€ */
        #loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--card-border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <div style="color: var(--text-sub)">åŒæ­¥äº‘ç«¯è´¦å•...</div>
    </div>

    <div class="container" id="app" style="display: none;">
        <div class="budget-card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 700; font-size: 18px;">æœˆåº¦é¢„ç®—ç›‘æ§</span>
                <span id="budget-percent" style="font-weight: 700;">0%</span>
            </div>
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            <div id="budget-status" style="font-size: 14px; color: var(--text-sub);">æ­£åœ¨è®¡ç®—æ¶ˆè€—...</div>
        </div>

        <div class="main-grid">
            <div class="card full-width">
                <h3>ğŸ“… å¹´åº¦æ”¶æ”¯æ¦‚è§ˆ</h3>
                <div class="chart-box" style="height: 350px;">
                    <canvas id="annualChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ• æ”¯å‡ºåˆ†å¸ƒ (ç‚¹å‡»æ‰‡åŒºå±•å¼€)</h3>
                <div class="chart-box">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“ˆ æ”¯å‡ºæ³¢åŠ¨è¶‹åŠ¿</h3>
                <div class="chart-box">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>

            <div class="card full-width" id="detail-section">
                <h3 id="detail-title">ğŸ“‚ åˆ†ç±»æ˜ç»†</h3>
                <div id="detail-list"></div>
            </div>
        </div>

        <div style="text-align: center; padding: 40px 0; color: var(--text-sub); font-size: 12px;">
            æ•°æ®å·²é€šè¿‡ç«¯åˆ°ç«¯åŠ å¯†åŒæ­¥
        </div>
    </div>

    <script>
        // ğŸš€ æ ¸å¿ƒï¼šä¿®æ”¹ä¸ºä½ çœŸå®çš„ Worker åŸŸå
        const WORKER_BASE = "https://moneydb.pzdmmsd.qzz.io";
        const userId = new URLSearchParams(window.location.search).get('user_id');

        async function init() {
            if (!userId) {
                document.getElementById('loader').innerHTML = "âš ï¸ è¯·é€šè¿‡æœºå™¨äººé“¾æ¥è®¿é—®";
                return;
            }

            try {
                const res = await fetch(`${WORKER_BASE}/api/data?user_id=${userId}`);
                const data = await res.json();
                renderDashboard(data);
                document.getElementById('app').style.display = 'block';
                document.getElementById('loader').style.display = 'none';
            } catch (e) {
                document.getElementById('loader').innerText = "âŒ æ— æ³•è¿æ¥æœåŠ¡å™¨";
            }
        }

        function renderDashboard(data) {
            // 1. é¢„ç®—é¢„è­¦é€»è¾‘
            const b = data.budget || { limit: 5000, current: 0, isOver: false };
            const percent = Math.min((b.current / b.limit) * 100, 100);
            const bar = document.getElementById('progress-bar');
            bar.style.width = percent + '%';
            bar.style.backgroundColor = b.isOver ? 'var(--danger)' : 'var(--primary)';
            document.getElementById('budget-percent').innerText = `${Math.round((b.current / b.limit) * 100)}%`;
            document.getElementById('budget-status').innerHTML = b.isOver 
                ? `<span class="over-budget-text">ğŸš¨ å·²è¶…å‡ºé¢„ç®— Â¥${(b.current - b.limit).toFixed(2)}</span>`
                : `æœ¬æœˆå·²èŠ± Â¥${b.current.toFixed(2)}ï¼Œå‰©ä½™å¯ç”¨ Â¥${(b.limit - b.current).toFixed(2)}`;

            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const gridColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
            Chart.defaults.color = isDark ? '#94a3b8' : '#64748b';

            // 2. å¹´åº¦åŒæŸ±çŠ¶å›¾
            new Chart(document.getElementById('annualChart'), {
                type: 'bar',
                data: {
                    labels: data.annual.map(i => `${i.month}æœˆ`),
                    datasets: [
                        { label: 'æ”¯å‡º', data: data.annual.map(i => i.exp), backgroundColor: '#6366f1', borderRadius: 6 },
                        { label: 'æ”¶å…¥', data: data.annual.map(i => i.inc), backgroundColor: '#10b981', borderRadius: 6 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { grid: { color: gridColor }, border: { display: false } }, x: { grid: { display: false } } }
                }
            });

            // 3. é¥¼å›¾ (æ— è¾¹æ¡† + æ‚¬åœçˆ†ç‚¸)
            new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: {
                    labels: data.pie.map(i => i.category),
                    datasets: [{
                        data: data.pie.map(i => i.value),
                        backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#06b6d4'],
                        borderWidth: 0,        // æ— ç™½è¾¹
                        hoverOffset: 30,       // æ‚¬åœå¼¹å‡º
                        spacing: 2             // é—´éš™
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } },
                    onClick: (e, els) => {
                        if (els.length > 0) {
                            const cat = data.pie[els[0].index].category;
                            fetchDetail(cat);
                        }
                    }
                }
            });

            // 4. è¶‹åŠ¿æŠ˜çº¿å›¾
            new Chart(document.getElementById('lineChart'), {
                type: 'line',
                data: {
                    labels: data.line.map(i => i.date.slice(5)),
                    datasets: [{
                        data: data.line.map(i => i.value),
                        borderColor: '#6366f1', borderWidth: 3, tension: 0.4, fill: true,
                        pointRadius: 0,
                        backgroundColor: 'rgba(99, 102, 241, 0.05)'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { display: false }, x: { grid: { display: false } } }
                }
            });
        }

        async function fetchDetail(category) {
            const section = document.getElementById('detail-section');
            const list = document.getElementById('detail-list');
            document.getElementById('detail-title').innerText = `ğŸ“‚ ${category} Â· æ¶ˆè´¹æ˜ç»†`;
            
            section.style.display = 'block';
            list.innerHTML = '<div style="padding:20px; text-align:center; opacity:0.5;">æ­£åœ¨è°ƒå–åŸå§‹å‡­è¯...</div>';
            
            const res = await fetch(`${WORKER_BASE}/api/data?user_id=${userId}&category=${encodeURIComponent(category)}`);
            const items = await res.json();
            
            list.innerHTML = items.map(i => `
                <div class="detail-row">
                    <div class="detail-info">
                        <span style="font-weight:600;">${i.description}</span>
                        <span class="detail-date">${i.date}</span>
                    </div>
                    <div class="detail-amt" style="color:${i.type==='income'?'var(--success)':'var(--danger)'}">
                        ${i.type==='income'?'+':'-'}${i.amount_original} ${i.currency_original}
                    </div>
                </div>
            `).join('');
            section.scrollIntoView({ behavior: 'smooth' });
        }

        // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–è‡ªåŠ¨åˆ·æ–°é¡µé¢
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => location.reload());

        init();
    </script>
</body>
</html>

