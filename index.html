<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI è´¢åŠ¡çœ‹æ¿ Pro+ ç»ˆæç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- 1. åŠ¨æ€ä¸»é¢˜å˜é‡ --- */
        :root {
            --bg: #f1f5f9; --card-bg: rgba(255, 255, 255, 0.85); --card-border: rgba(255, 255, 255, 0.5);
            --text-main: #1e293b; --text-sub: #64748b; --primary: #6366f1;
            --success: #10b981; --danger: #ef4444; --grid-line: rgba(0, 0, 0, 0.05);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #030712; --card-bg: rgba(17, 24, 39, 0.7); --card-border: rgba(255, 255, 255, 0.08);
                --text-main: #f8fafc; --text-sub: #94a3b8; --grid-line: rgba(255, 255, 255, 0.05);
            }
        }

        /* --- 2. åŸºç¡€å¸ƒå±€ --- */
        * { box-sizing: border-box; transition: background-color 0.3s, border-color 0.3s; }
        body {
            font-family: -apple-system, "SF Pro Display", "PingFang SC", sans-serif;
            background-color: var(--bg); color: var(--text-main);
            margin: 0; padding: 20px; min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }

        /* --- 3. é¢„ç®—é¢„è­¦æ¡ --- */
        .budget-card {
            margin-bottom: 24px; padding: 24px; border-radius: 24px;
            background: var(--card-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--card-border); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
        }
        .progress-container { height: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; overflow: hidden; margin: 12px 0; }
        @media (prefers-color-scheme: dark) { .progress-container { background: rgba(255,255,255,0.1); } }
        .progress-bar { height: 100%; width: 0; transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1); border-radius: 6px; }
        
        .over-budget-text { color: var(--danger); font-weight: 800; animation: shake 0.6s ease-in-out infinite alternate; display: inline-block; }
        @keyframes shake { from { transform: translateX(0); } to { transform: translateX(5px); } }

        /* --- 4. å“åº”å¼æ …æ ¼ç³»ç»Ÿ --- */
        .main-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        .full-width { grid-column: 1 / -1; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        /* --- 5. å¡ç‰‡æ ·å¼ --- */
        .card {
            background: var(--card-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--card-border); border-radius: 28px; padding: 24px;
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.05);
        }
        .card h3 { font-size: 16px; margin: 0 0 20px; display: flex; align-items: center; letter-spacing: 0.5px; }
        .card h3::before { content: ""; width: 4px; height: 16px; background: var(--primary); margin-right: 10px; border-radius: 2px; }

        .chart-box { position: relative; width: 100%; height: 320px; }

        /* --- 6. ä¸‹é’»æ˜ç»†åˆ—è¡¨ --- */
        #detail-section { margin-top: 24px; display: none; }
        .detail-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 0; border-bottom: 1px solid var(--grid-line);
        }
        .detail-row:last-child { border: none; }
        .detail-amt { font-weight: 800; font-family: "SF Mono", "Consolas", monospace; }

        /* åŠ è½½çŠ¶æ€ */
        #loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 100; }
        .spinner { width: 45px; height: 45px; border: 4px solid var(--card-border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <div style="color: var(--text-sub); font-size: 14px; font-weight: 500;">AI æ­£åœ¨åŒæ­¥è´¦å•èµ„äº§...</div>
    </div>

    <div class="container" id="app" style="display: none;">
        <div class="budget-card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 800; font-size: 18px;">æœˆåº¦é¢„ç®—æ¶ˆè€—</span>
                <span id="budget-percent" style="font-weight: 800; font-family: monospace;">0%</span>
            </div>
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            <div id="budget-status" style="font-size: 14px; color: var(--text-sub);">æ­£åœ¨ä» D1 æ•°æ®åº“è°ƒå–å®æ—¶é¢åº¦...</div>
        </div>

        <div class="main-grid">
            <div class="card full-width">
                <h3>ğŸ“… å¹´åº¦æ”¶æ”¯æ¦‚è§ˆ</h3>
                <div class="chart-box" style="height: 380px;">
                    <canvas id="annualChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ• æ”¯å‡ºæ„æˆ (ç‚¹å‡»æ‰‡åŒºä¸‹é’»)</h3>
                <div class="chart-box">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“ˆ è¿‘ 30 å¤©æ”¯å‡ºæ›²çº¿</h3>
                <div class="chart-box">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>

            <div class="card full-width" id="detail-section">
                <h3 id="detail-title">ğŸ“‚ åˆ†ç±»æµæ°´è¯¦æƒ…</h3>
                <div id="detail-list"></div>
            </div>
        </div>

        <div style="text-align: center; padding: 50px 0; color: var(--text-sub); font-size: 12px; letter-spacing: 1px; opacity: 0.6;">
            SECURE CLOUD SYNCED Â· POWERED BY WORKERS & D1
        </div>
    </div>

    <script>
        const WORKER_BASE = "https://moneydb.pzdmmsd.qzz.io";
        const userId = new URLSearchParams(window.location.search).get('user_id');

        async function init() {
            if (!userId) {
                document.getElementById('loader').innerHTML = "âš ï¸ è¯·é€šè¿‡æœºå™¨äººç”Ÿæˆçš„ä¸“å±é“¾æ¥è¿›å…¥çœ‹æ¿";
                return;
            }

            try {
                const res = await fetch(`${WORKER_BASE}/api/data?user_id=${userId}`);
                const data = await res.json();
                renderDashboard(data);
                document.getElementById('app').style.display = 'block';
                document.getElementById('loader').style.display = 'none';
            } catch (e) {
                document.getElementById('loader').innerText = "âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ Worker éƒ¨ç½²";
            }
        }

        function renderDashboard(data) {
            const b = data.budget || { limit: 5000, current: 0, isOver: false };
            const percent = Math.min((b.current / b.limit) * 100, 100);
            const bar = document.getElementById('progress-bar');
            bar.style.width = percent + '%';
            bar.style.backgroundColor = b.isOver ? 'var(--danger)' : 'var(--primary)';
            document.getElementById('budget-percent').innerText = `${Math.round((b.current / b.limit) * 100)}%`;
            document.getElementById('budget-status').innerHTML = b.isOver 
                ? `<span class="over-budget-text">ğŸš¨ å·²è¶…æ”¯ Â¥${(b.current - b.limit).toFixed(2)}</span>`
                : `æœ¬æœˆå‰©ä½™å¯ç”¨ï¼šÂ¥${(b.limit - b.current).toFixed(2)}`;

            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const gridColor = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)';
            Chart.defaults.color = isDark ? '#94a3b8' : '#64748b';

            // 1. å¹´åº¦æŸ±çŠ¶å›¾ (ä¼˜åŒ–ï¼šé™åˆ¶æœ€å¤§å®½åº¦)
            new Chart(document.getElementById('annualChart'), {
                type: 'bar',
                data: {
                    labels: data.annual.map(i => `${i.month}æœˆ`),
                    datasets: [
                        { label: 'æ”¯å‡º', data: data.annual.map(i => i.exp), backgroundColor: '#6366f1', borderRadius: 8, maxBarThickness: 30 },
                        { label: 'æ”¶å…¥', data: data.annual.map(i => i.inc), backgroundColor: '#10b981', borderRadius: 8, maxBarThickness: 30 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { 
                        y: { grid: { color: gridColor }, border: { display: false } }, 
                        x: { grid: { display: false } } 
                    }
                }
            });

            // 2. é¥¼å›¾ (æ— è¾¹æ¡† + è§£å†³æº¢å‡º)
            new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: {
                    labels: data.pie.map(i => i.category),
                    datasets: [{
                        data: data.pie.map(i => i.value),
                        backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#06b6d4'],
                        borderWidth: 0, hoverOffset: 35, spacing: 3
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: 40 }, // ç•™å‡ºè¶³å¤Ÿç©ºé—´ä¾› hover å¼¹å‡º
                    cutout: '72%',
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true, padding: 15 } } },
                    onClick: (e, els) => { if (els.length > 0) fetchDetail(data.pie[els[0].index].category); }
                }
            });

            // 3. è¶‹åŠ¿å›¾
            new Chart(document.getElementById('lineChart'), {
                type: 'line',
                data: {
                    labels: data.line.map(i => i.date.slice(5)),
                    datasets: [{
                        data: data.line.map(i => i.value),
                        borderColor: '#6366f1', borderWidth: 4, tension: 0.45, fill: true, pointRadius: 0,
                        backgroundColor: (c) => {
                            const g = c.chart.ctx.createLinearGradient(0, 0, 0, 300);
                            g.addColorStop(0, 'rgba(99, 102, 241, 0.2)'); g.addColorStop(1, 'rgba(99, 102, 241, 0)');
                            return g;
                        }
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { display: false }, x: { grid: { display: false } } }
                }
            });
        }

        async function fetchDetail(category) {
            const section = document.getElementById('detail-section');
            const list = document.getElementById('detail-list');
            document.getElementById('detail-title').innerText = `ğŸ“‚ ${category} Â· æ¶ˆè´¹æ˜ç»†å›é¡¾`;
            section.style.display = 'block';
            list.innerHTML = '<div style="padding:30px; text-align:center; opacity:0.4;">æ­£åœ¨æ£€ç´¢æ•°æ®åº“...</div>';
            const res = await fetch(`${WORKER_BASE}/api/data?user_id=${userId}&category=${encodeURIComponent(category)}`);
            const items = await res.json();
            list.innerHTML = items.map(i => `
                <div class="detail-row">
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-weight:700; font-size:15px;">${i.description}</span>
                        <span style="font-size:12px; color:var(--text-sub); margin-top:2px;">${i.date}</span>
                    </div>
                    <div class="detail-amt" style="color:${i.type==='income'?'var(--success)':'var(--danger)'}">
                        ${i.type==='income'?'+':'-'}${Number(i.amount_original).toLocaleString()} ${i.currency_original}
                    </div>
                </div>
            `).join('');
            section.scrollIntoView({ behavior: 'smooth' });
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => location.reload());
        init();
    </script>
</body>
</html>
