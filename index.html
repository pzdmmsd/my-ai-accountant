<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI è´¢åŠ¡èµ„äº§ç®¡å®¶ Pro+</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #f1f5f9; --card-bg: rgba(255, 255, 255, 0.85); --card-border: rgba(255, 255, 255, 0.5);
            --text-main: #1e293b; --text-sub: #64748b; --primary: #6366f1;
            --success: #10b981; --danger: #ef4444; --grid-line: rgba(0, 0, 0, 0.05);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #030712; --card-bg: rgba(17, 24, 39, 0.7); --card-border: rgba(255, 255, 255, 0.08);
                --text-main: #f8fafc; --text-sub: #94a3b8; --grid-line: rgba(255, 255, 255, 0.05);
            }
        }

        body { font-family: -apple-system, sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 20px; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; }

        /* --- ä¿®æ­£ï¼šå…¨å±å¤§æ ‡é¢˜ --- */
        .page-title { text-align: center; margin-bottom: 30px; }
        .page-title h1 { font-size: 28px; font-weight: 800; letter-spacing: -1px; margin: 0; }
        .page-title p { color: var(--text-sub); font-size: 14px; margin-top: 5px; opacity: 0.8; }

        /* --- åŠ è½½å™¨ --- */
        #loader { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--bg); z-index: 1000; }
        .spinner { width: 50px; height: 50px; border: 5px solid var(--card-border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- å¡ç‰‡å¸ƒå±€ --- */
        .card { background: var(--card-bg); backdrop-filter: blur(15px); border-radius: 28px; padding: 24px; border: 1px solid var(--card-border); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.05); margin-bottom: 24px; }
        .main-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        .full-width { grid-column: 1 / -1; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        /* --- æ ‡é¢˜ä¸ç­›é€‰å™¨ --- */
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card h3 { font-size: 16px; margin: 0; display: flex; align-items: center; }
        .card h3::before { content: ""; width: 4px; height: 16px; background: var(--primary); margin-right: 10px; border-radius: 2px; }
        
        select { background: var(--bg); color: var(--text-main); border: 1px solid var(--card-border); padding: 5px 10px; border-radius: 10px; font-size: 12px; outline: none; cursor: pointer; }

        .chart-box { position: relative; width: 100%; height: 320px; }
        .detail-row { display: flex; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid var(--grid-line); }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div><div>AI æ­£åœ¨å®¡è®¡è´¦ç›®èµ„äº§...</div></div>

    <div class="container" id="app" style="display: none;">
        <div class="page-title">
            <h1>AI è´¢åŠ¡èµ„äº§ç®¡å®¶ Pro+</h1>
            <p>åŸºäº DeepSeek & GLM-4V çš„æ™ºèƒ½è®°è´¦åˆ†æç³»ç»Ÿ</p>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 800;">æœˆåº¦é¢„ç®—é™é¢</span>
                <span id="budget-percent" style="font-weight: 800;">0%</span>
            </div>
            <div style="height: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; overflow: hidden; margin: 12px 0;">
                <div id="progress-bar" style="height: 100%; width: 0; transition: width 1s ease;"></div>
            </div>
            <div id="budget-status" style="font-size: 13px; color: var(--text-sub);">æ­£åœ¨åŒæ­¥...</div>
        </div>

        <div class="main-grid">
            <div class="card full-width">
                <h3>ğŸ“… å¹´åº¦æ”¶æ”¯æ¦‚è§ˆ</h3>
                <div class="chart-box" style="height: 380px;"><canvas id="annualChart"></canvas></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 id="pie-title">æ”¯å‡ºæ„æˆ</h3>
                    <select id="monthSelector" onchange="changePieMonth(this.value)"></select>
                </div>
                <div class="chart-box"><canvas id="pieChart"></canvas></div>
            </div>

            <div class="card">
                <h3>ğŸ“ˆ æ”¯å‡ºæ³¢åŠ¨è¶‹åŠ¿ (30D)</h3>
                <div class="chart-box"><canvas id="lineChart"></canvas></div>
            </div>

            <div class="card full-width" id="detail-section">
                <h3 id="detail-title">ğŸ“‚ åˆ†ç±»æ˜ç»†</h3>
                <div id="detail-list"></div>
            </div>
        </div>
    </div>

    <script>
        const WORKER_BASE = "https://moneydb.pzdmmsd.qzz.io";
        const userId = new URLSearchParams(window.location.search).get('user_id');
        let pieChart;

        async function init() {
            if (!userId) { document.getElementById('loader').innerText = "âš ï¸ è¯·ä»æœºå™¨äººè¿›å…¥"; return; }
            try {
                const res = await fetch(`${WORKER_BASE}/api/data?user_id=${userId}`);
                const data = await res.json();
                
                // åˆå§‹åŒ–æœˆä»½ä¸‹æ‹‰æ¡†
                const selector = document.getElementById('monthSelector');
                data.months.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.m; opt.innerText = m.m;
                    selector.appendChild(opt);
                });
                selector.value = new Date().toISOString().slice(0, 7);
                document.getElementById('pie-title').innerText = `${selector.value} æ”¯å‡ºæ„æˆ`;

                renderDashboard(data);
                document.getElementById('app').style.display = 'block';
                document.getElementById('loader').style.display = 'none';
            } catch (e) { document.getElementById('loader').innerText = "âŒ åŠ è½½å¤±è´¥"; }
        }

        async function changePieMonth(month) {
            document.getElementById('pie-title').innerText = `${month} æ”¯å‡ºæ„æˆ`;
            const res = await fetch(`${WORKER_BASE}/api/data?user_id=${userId}&month=${month}`);
            const newData = await res.json();
            
            pieChart.data.labels = newData.map(i => i.category);
            pieChart.data.datasets[0].data = newData.map(i => i.value);
            pieChart.update();
        }

        function renderDashboard(data) {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const gridColor = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)';
            Chart.defaults.color = isDark ? '#94a3b8' : '#64748b';

            // 1. é¢„ç®—
            const b = data.budget;
            const percent = Math.min((b.current / b.limit) * 100, 100);
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-bar').style.backgroundColor = b.isOver ? 'var(--danger)' : 'var(--primary)';
            document.getElementById('budget-percent').innerText = `${Math.round((b.current / b.limit) * 100)}%`;
            document.getElementById('budget-status').innerText = b.isOver ? `ğŸš¨ å·²è¶…é¢ Â¥${(b.current-b.limit).toFixed(2)}` : `å‰©ä½™å¯ç”¨ Â¥${(b.limit-b.current).toFixed(2)}`;

            // 2. å¹´åº¦æŸ±çŠ¶å›¾ (åŠ åšç‰ˆ)
            new Chart(document.getElementById('annualChart'), {
                type: 'bar',
                data: {
                    labels: data.annual.map(i => `${i.month}æœˆ`),
                    datasets: [
                        { label: 'æ”¯å‡º', data: data.annual.map(i => i.exp), backgroundColor: '#6366f1', borderRadius: 6, barPercentage: 0.9, categoryPercentage: 0.5 },
                        { label: 'æ”¶å…¥', data: data.annual.map(i => i.inc), backgroundColor: '#10b981', borderRadius: 6, barPercentage: 0.9, categoryPercentage: 0.5 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: gridColor }, border: { display: false } } } }
            });

            // 3. é¥¼å›¾ (ä¿å­˜å¼•ç”¨ä»¥ä¾¿åˆ‡æ¢)
            pieChart = new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: {
                    labels: data.pie.map(i => i.category),
                    datasets: [{ data: data.pie.map(i => i.value), backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6'], borderWidth: 0, hoverOffset: 40, spacing: 4 }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, layout: { padding: 40 }, cutout: '72%',
                    plugins: { legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } },
                    onClick: (e, els) => { if (els.length > 0) fetchDetail(pieChart.data.labels[els[0].index]); }
                }
            });

            // 4. è¶‹åŠ¿å›¾ (å¼€å¯ç‚¹ä½)
            new Chart(document.getElementById('lineChart'), {
                type: 'line',
                data: {
                    labels: data.line.map(i => i.date.slice(5)),
                    datasets: [{
                        data: data.line.map(i => i.value), borderColor: '#6366f1', borderWidth: 4, tension: 0.4, fill: true,
                        pointRadius: 6, pointHoverRadius: 9, backgroundColor: 'rgba(99, 102, 241, 0.1)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
            });
        }

        async function fetchDetail(cat) {
            const section = document.getElementById('detail-section');
            const list = document.getElementById('detail-list');
            section.style.display = 'block';
            list.innerHTML = 'è¯»å–ä¸­...';
            const res = await fetch(`${WORKER_BASE}/api/data?user_id=${userId}&category=${encodeURIComponent(cat)}`);
            const items = await res.json();
            document.getElementById('detail-title').innerText = `ğŸ“‚ ${cat} Â· æ˜ç»†`;
            list.innerHTML = items.map(i => `<div class="detail-row"><div><b>${i.description}</b><br><small>${i.date}</small></div><div style="color:${i.type==='income'?'var(--success)':'var(--danger)'};font-weight:800;">${i.type==='income'?'+':'-'}${i.amount_original} ${i.currency_original}</div></div>`).join('');
            section.scrollIntoView({ behavior: 'smooth' });
        }

        init();
    </script>
</body>
</html>
