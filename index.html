<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä¸ªäººè´¦å•æŠ¥è¡¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --p: #4f46e5; --bg: #f9fafb; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1f2937; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { margin-bottom: 24px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-val { font-size: 24px; font-weight: bold; margin-top: 8px; color: var(--p); }
        .chart-container { position: relative; height: 300px; margin-bottom: 24px; }
        #status { text-align: center; padding: 40px; color: #6b7280; }
    </style>
</head>
<body>
    <div class="container" id="app" style="display: none;">
        <div class="header"><h1>ğŸ“Š è´¢åŠ¡åˆ†æçœ‹æ¿</h1></div>
        
        <div class="grid">
            <div class="card"><div>æ€»æ”¯å‡º (CNY)</div><div id="total-expense" class="stat-val">Â¥0.00</div></div>
            <div class="card"><div>æ€»æ”¶å…¥ (CNY)</div><div id="total-income" class="stat-val">Â¥0.00</div></div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>åˆ†ç±»æ”¯å‡ºå æ¯”</h3>
                <div class="chart-container"><canvas id="pieChart"></canvas></div>
            </div>
            <div class="card">
                <h3>æœ€è¿‘ 30 å¤©æ”¯å‡ºè¶‹åŠ¿</h3>
                <div class="chart-container"><canvas id="lineChart"></canvas></div>
            </div>
        </div>
    </div>
    <div id="status">æ­£åœ¨åŠ è½½æ‚¨çš„è´¦å•æ•°æ®...</div>

    <script>
        // ğŸš€ ä¿®æ”¹è¿™é‡Œï¼šå¡«å†™ä½ çš„ Worker å®Œæ•´åœ°å€ (å¿…é¡» https å¼€å¤´)
        const WORKER_BASE = "https://moneydb.pzdmmsd.qzz.io";

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const userId = params.get('user_id');

            if (!userId) {
                document.getElementById('status').innerText = "âš ï¸ æœªæ£€æµ‹åˆ° User IDï¼Œè¯·é€šè¿‡æœºå™¨äººé“¾æ¥è®¿é—®ã€‚";
                return;
            }

            try {
                const res = await fetch(`${WORKER_BASE}/api/data?user_id=${userId}`);
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();

                render(data);
                document.getElementById('app').style.display = 'block';
                document.getElementById('status').style.display = 'none';
            } catch (e) {
                document.getElementById('status').innerHTML = `âŒ åŠ è½½å¤±è´¥: ${e.message}<br><small>è¯·æ£€æŸ¥ Worker æ˜¯å¦é…ç½®äº†æ­£ç¡®çš„ CORS å“åº”</small>`;
            }
        }

        function render(data) {
            const exp = data.totals.find(t => t.type === 'expense')?.total || 0;
            const inc = data.totals.find(t => t.type === 'income')?.total || 0;
            document.getElementById('total-expense').innerText = `Â¥${Number(exp).toFixed(2)}`;
            document.getElementById('total-income').innerText = `Â¥${Number(inc).toFixed(2)}`;

            // é¥¼å›¾
            new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: {
                    labels: data.pie.map(i => i.category),
                    datasets: [{ data: data.pie.map(i => i.value), backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }]
                }
            });

            // æŠ˜çº¿å›¾
            new Chart(document.getElementById('lineChart'), {
                type: 'line',
                data: {
                    labels: data.line.map(i => i.date.slice(5)),
                    datasets: [{ label: 'æ—¥æ”¯å‡º', data: data.line.map(i => i.value), borderColor: '#4f46e5', tension: 0.3, fill: true, backgroundColor: 'rgba(79, 70, 229, 0.1)' }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        init();
    </script>
</body>
</html>
