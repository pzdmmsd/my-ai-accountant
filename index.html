<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI è´¢åŠ¡çœ‹æ¿ Pro+ ç»ˆæç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #f1f5f9; --card-bg: rgba(255, 255, 255, 0.85); --card-border: rgba(255, 255, 255, 0.5);
            --text-main: #1e293b; --text-sub: #64748b; --primary: #6366f1;
            --success: #10b981; --danger: #ef4444; --grid-line: rgba(0, 0, 0, 0.05);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #030712; --card-bg: rgba(17, 24, 39, 0.7); --card-border: rgba(255, 255, 255, 0.08);
                --text-main: #f8fafc; --text-sub: #94a3b8; --grid-line: rgba(255, 255, 255, 0.05);
            }
        }

        * { box-sizing: border-box; transition: background-color 0.3s, border-color 0.3s; }
        body {
            font-family: -apple-system, "SF Pro Display", "PingFang SC", sans-serif;
            background-color: var(--bg); color: var(--text-main);
            margin: 0; padding: 20px; min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }

        /* --- ä¿®æ­£ï¼šå®Œç¾å±…ä¸­çš„åŠ è½½å™¨ --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: var(--bg); z-index: 1000;
        }
        .spinner { 
            width: 50px; height: 50px; border: 5px solid var(--card-border); 
            border-top-color: var(--primary); border-radius: 50%; 
            animation: spin 1s linear infinite; margin-bottom: 20px; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- å¸ƒå±€ä¸å¡ç‰‡ --- */
        .budget-card {
            margin-bottom: 24px; padding: 24px; border-radius: 24px;
            background: var(--card-bg); backdrop-filter: blur(15px); border: 1px solid var(--card-border);
        }
        .progress-container { height: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; overflow: hidden; margin: 12px 0; }
        @media (prefers-color-scheme: dark) { .progress-container { background: rgba(255,255,255,0.1); } }
        .progress-bar { height: 100%; width: 0; transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1); border-radius: 6px; }
        
        .main-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        .full-width { grid-column: 1 / -1; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        .card {
            background: var(--card-bg); backdrop-filter: blur(15px); border-radius: 28px; padding: 24px;
            border: 1px solid var(--card-border); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.05);
        }
        .card h3 { font-size: 16px; margin: 0 0 20px; display: flex; align-items: center; }
        .card h3::before { content: ""; width: 4px; height: 16px; background: var(--primary); margin-right: 10px; border-radius: 2px; }

        .chart-box { position: relative; width: 100%; height: 320px; }

        #detail-section { margin-top: 24px; display: none; }
        .detail-row { display: flex; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid var(--grid-line); }
        .detail-amt { font-weight: 800; font-family: monospace; }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <div style="color: var(--text-sub); font-weight: 600; letter-spacing: 1px;">AI æ­£åœ¨æ ¸å¯¹è´¦ç›®...</div>
    </div>

    <div class="container" id="app" style="display: none;">
        <div class="budget-card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 800; font-size: 18px;">æœˆåº¦é¢„ç®—æ¶ˆè€—</span>
                <span id="budget-percent" style="font-weight: 800;">0%</span>
            </div>
            <div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div>
            <div id="budget-status" style="font-size: 14px; color: var(--text-sub);">åŒæ­¥ D1 æ•°æ®åº“ä¸­...</div>
        </div>

        <div class="main-grid">
            <div class="card full-width">
                <h3>ğŸ“… å¹´åº¦æ”¶æ”¯æ¦‚è§ˆ (æ”¯æ”¶å¯¹æ¯”)</h3>
                <div class="chart-box" style="height: 380px;"><canvas id="annualChart"></canvas></div>
            </div>

            <div class="card">
                <h3>ğŸ• æ”¯å‡ºæ„æˆ (ç‚¹å‡»æ‰‡åŒºä¸‹é’»)</h3>
                <div class="chart-box"><canvas id="pieChart"></canvas></div>
            </div>

            <div class="card">
                <h3>ğŸ“ˆ æ”¯å‡ºè¶‹åŠ¿ (ç‚¹å‡»ç«¯ç‚¹æŸ¥çœ‹æ•°æ®)</h3>
                <div class="chart-box"><canvas id="lineChart"></canvas></div>
            </div>

            <div class="card full-width" id="detail-section">
                <h3 id="detail-title">ğŸ“‚ åˆ†ç±»æµæ°´</h3>
                <div id="detail-list"></div>
            </div>
        </div>
    </div>

    <script>
        const WORKER_BASE = "https://moneydb.pzdmmsd.qzz.io";
        const userId = new URLSearchParams(window.location.search).get('user_id');

        async function init() {
            if (!userId) {
                document.getElementById('loader').innerHTML = "âš ï¸ è¯·ä½¿ç”¨æœºå™¨äººç”Ÿæˆçš„é“¾æ¥è®¿é—®";
                return;
            }
            try {
                const res = await fetch(`${WORKER_BASE}/api/data?user_id=${userId}`);
                const data = await res.json();
                renderDashboard(data);
                document.getElementById('app').style.display = 'block';
                document.getElementById('loader').style.display = 'none';
            } catch (e) {
                document.getElementById('loader').innerText = "âŒ æ— æ³•è¿æ¥æœåŠ¡å™¨";
            }
        }

        function renderDashboard(data) {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const gridColor = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)';
            Chart.defaults.color = isDark ? '#94a3b8' : '#64748b';

            // 1. é¢„ç®—é€»è¾‘
            const b = data.budget;
            const percent = Math.min((b.current / b.limit) * 100, 100);
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-bar').style.backgroundColor = b.isOver ? 'var(--danger)' : 'var(--primary)';
            document.getElementById('budget-percent').innerText = `${Math.round((b.current / b.limit) * 100)}%`;
            document.getElementById('budget-status').innerText = b.isOver ? `ğŸš¨ å·²è¶…æ”¯ Â¥${(b.current - b.limit).toFixed(2)}` : `å‰©ä½™å¯ç”¨ï¼šÂ¥${(b.limit - b.current).toFixed(2)}`;

            // 2. å¹´åº¦æŸ±çŠ¶å›¾ (ä¼˜åŒ–ï¼šåŠ ç²—æŸ±å­)
            new Chart(document.getElementById('annualChart'), {
                type: 'bar',
                data: {
                    labels: data.annual.map(i => `${i.month}æœˆ`),
                    datasets: [
                        { label: 'æ”¯å‡º', data: data.annual.map(i => i.exp), backgroundColor: '#6366f1', borderRadius: 6, barPercentage: 0.8, categoryPercentage: 0.6 },
                        { label: 'æ”¶å…¥', data: data.annual.map(i => i.inc), backgroundColor: '#10b981', borderRadius: 6, barPercentage: 0.8, categoryPercentage: 0.6 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: gridColor }, border: { display: false } }, x: { grid: { display: false } } } }
            });

            // 3. é¥¼å›¾ (æ— è¾¹æ¡† + çˆ†ç‚¸æ•ˆæœ)
            new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: {
                    labels: data.pie.map(i => i.category),
                    datasets: [{ data: data.pie.map(i => i.value), backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6'], borderWidth: 0, hoverOffset: 40, spacing: 4 }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, layout: { padding: 40 }, cutout: '72%',
                    plugins: { legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } },
                    onClick: (e, els) => { if (els.length > 0) fetchDetail(data.pie[els[0].index].category); }
                }
            });

            // 4. æ”¯å‡ºè¶‹åŠ¿ (ä¼˜åŒ–ï¼šå¼€å¯å¯ç‚¹å‡»çš„æ•°æ®ç‚¹)
            new Chart(document.getElementById('lineChart'), {
                type: 'line',
                data: {
                    labels: data.line.map(i => i.date.slice(5)),
                    datasets: [{
                        label: 'å•æ—¥æ¶ˆè´¹',
                        data: data.line.map(i => i.value),
                        borderColor: '#6366f1', borderWidth: 4, tension: 0.4, fill: true,
                        pointRadius: 6,           // å¼€å¯åœ†ç‚¹
                        pointHoverRadius: 9,      // æ‚¬åœå˜å¤§
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        backgroundColor: (c) => {
                            const g = c.chart.ctx.createLinearGradient(0, 0, 0, 300);
                            g.addColorStop(0, 'rgba(99, 102, 241, 0.25)'); g.addColorStop(1, 'rgba(99, 102, 241, 0)');
                            return g;
                        }
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false }, // é™„è¿‘å³å¯è§¦å‘æ•°æ®æç¤º
                    plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', padding: 12, cornerRadius: 10 } },
                    scales: { y: { display: false }, x: { grid: { display: false } } }
                }
            });
        }

        async function fetchDetail(cat) {
            const section = document.getElementById('detail-section');
            const list = document.getElementById('detail-list');
            section.style.display = 'block';
            list.innerHTML = '<div style="padding:20px;text-align:center;">è¯»å–ä¸­...</div>';
            const res = await fetch(`${WORKER_BASE}/api/data?user_id=${userId}&category=${encodeURIComponent(cat)}`);
            const items = await res.json();
            document.getElementById('detail-title').innerText = `ğŸ“‚ ${cat} Â· æ˜ç»†å›é¡¾`;
            list.innerHTML = items.map(i => `
                <div class="detail-row">
                    <div><b>${i.description}</b><br><small style="color:var(--text-sub)">${i.date}</small></div>
                    <div class="detail-amt" style="color:${i.type==='income'?'var(--success)':'var(--danger)'}">
                        ${i.type==='income'?'+':'-'}${i.amount_original} ${i.currency_original}
                    </div>
                </div>
            `).join('');
            section.scrollIntoView({ behavior: 'smooth' });
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => location.reload());
        init();
    </script>
</body>
</html>
